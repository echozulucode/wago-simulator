version: 2

sim:
  name: 'Remote I/O Simulator'
  seed: 12345
  tick_ms: 10
  timezone: 'America/Chicago'

transport:
  kind: 'modbus_tcp'
  listen:
    host: '0.0.0.0'
    port: 502
  unit_id: 1

process_image:
  layout: 'wago_750_default'
  word_endian: 'big'
  byte_order_in_word: 'big'
  align_modules_to: 2

modbus_map:
  inputs:
    kind: 'input_registers'
    base: 0
  outputs:
    kind: 'holding_registers'
    base: 0

racks:
  - id: 'rack0'
    model: 'wago-modbustcp'
    name: 'Remote Rack 0'

    modules:
      - id: 'r0m0'
        model: '750-1415'
        name: 'DI_MAIN'
        channels: []
      - id: 'r0m1'
        model: '750-1515'
        name: 'DO_MAIN'
        channels: []
      - id: 'r0m2'
        model: '750-455'
        name: 'AI_PROCESS'
        channels: []
      - id: 'r0m3'
        model: '750-464'
        name: 'RTD_WATER'
        channels: []
      - id: 'r0m4'
        model: '750-563'
        name: 'AO_VALVES'
        channels: []

scenarios:
  - name: 'Contactor Simulation'
    description: 'Reactively simulates contactor auxiliary contacts based on Coil Output.'
    version: '1.0'
    loop_enabled: true
    steps:
      # Step 1: Wait for Output 0 (Coil) to be turned ON
      - trigger_module: 1
        trigger_channel: 0
        trigger_value: 1.0
        # After Coil turns ON, wait 100ms for mechanical movement
        delay_ms: 100
        module_position: 0
        channel: 0
        action: 'set'
        value: 1.0 # N.O. closes

      # Step 2: In same reaction, toggle N.C.
      - module_position: 0
        channel: 1
        action: 'set'
        value: 0.0 # N.C. opens

      # Step 3: Wait for Output 0 (Coil) to be turned OFF
      - trigger_module: 1
        trigger_channel: 0
        trigger_value: 0.0
        # After Coil turns OFF, wait 100ms for mechanical return
        delay_ms: 100
        module_position: 0
        channel: 0
        action: 'set'
        value: 0.0 # N.O. opens

      # Step 4: In same reaction, toggle N.C.
      - module_position: 0
        channel: 1
        action: 'set'
        value: 1.0 # N.C. closes

# Reactive scenarios define continuous I/O relationships (new format)
reactive_scenarios:
  - name: 'Sunny Day'
    type: 'reactive'
    description: 'Normal operation - direct feedback with realistic delays'
    default: true
    behaviors:
      # Contactor N.O. feedback: DO channel 0 -> DI channel 0 (with 50ms delay)
      - id: 'contactor_no_feedback'
        source: { modulePosition: 1, channel: 0 }
        target: { modulePosition: 0, channel: 0 }
        mapping: 'direct'
        delayMs: 50
        enabled: true

      # Contactor N.C. feedback: DO channel 0 -> DI channel 1 (inverted)
      - id: 'contactor_nc_feedback'
        source: { modulePosition: 1, channel: 0 }
        target: { modulePosition: 0, channel: 1 }
        mapping: 'inverted'
        delayMs: 50
        enabled: true

      # Temperature sensor simulation: constant room temp
      - id: 'room_temp'
        target: { modulePosition: 3, channel: 0 }
        mapping: 'constant'
        value: 22.5
        enabled: true

  - name: 'Equipment Failure'
    type: 'reactive'
    description: 'Simulates contactor failure (stuck open)'
    default: false
    behaviors:
      # Contactor stuck - N.O. always open
      - id: 'contactor_no_stuck'
        target: { modulePosition: 0, channel: 0 }
        mapping: 'constant'
        value: 0.0
        enabled: true

      # N.C. stays closed
      - id: 'contactor_nc_stuck'
        target: { modulePosition: 0, channel: 1 }
        mapping: 'constant'
        value: 1.0
        enabled: true
